generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  CONSUMER
  COMPANY_OWNER
  COMPANY_ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  DISABLED
}

model User {
  id               String     @id @default(uuid())
  email            String     @unique
  passwordHash     String     @map("password")
  name             String?
  roles            UserRole[]
  status           UserStatus @default(ACTIVE)
  refreshTokenHash String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  consumer  Consumer?
  company   Company?
  userRoles UserRoleAssignment[]

  @@map("users")
}

enum CompanyStatus {
  ACTIVE
  INACTIVE
  PENDING
}

enum CompanyCategory {
  FOOD_AND_BEVERAGE
  RETAIL
  SERVICES
  HEALTH
  EDUCATION
  TECHNOLOGY
  CONSTRUCTION
  TRANSPORT
  TOURISM_AND_HOSPITALITY
  BEAUTY_AND_AESTHETICS
  AUTOMOTIVE
  REAL_ESTATE
  FINANCIAL
  ENTERTAINMENT
  FASHION_AND_APPAREL
  SPORTS_AND_FITNESS
  PET_SERVICES
  LEGAL
  CONSULTING
  MANUFACTURING
  AGRICULTURE
  ENERGY
  TELECOMMUNICATIONS
  MEDIA_AND_ADVERTISING
  NON_PROFIT
  OTHER
}

model Company {
  id        String          @id @default(uuid())
  userId    String          @unique
  cnpj      String          @unique
  name      String
  category  CompanyCategory
  status    CompanyStatus   @default(ACTIVE)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  feedbacks Feedback[]

  @@map("companies")
}

model Consumer {
  id        String   @id @default(uuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  feedbacks Feedback[]

  @@map("consumers")
}

enum FeedbackStatus {
  ACTIVE
  MODERATED
  DELETED
}

model Feedback {
  id         String         @id @default(uuid())
  consumerId String
  companyId  String
  rating     Int
  comment    String?
  status     FeedbackStatus @default(ACTIVE)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  consumer Consumer @relation(fields: [consumerId], references: [id], onDelete: Cascade)
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([consumerId])
  @@map("feedbacks")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permissions RolePermission[]
  userRoles   UserRoleAssignment[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  resource    String
  action      String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles RolePermission[]

  @@map("permissions")
}

model UserRoleAssignment {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}
